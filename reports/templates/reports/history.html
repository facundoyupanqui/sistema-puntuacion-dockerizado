{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2>Historial de Actividades</h2>

  <form method="get" class="filters" style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 120px; gap: 8px; align-items:end;">
    <div>
      <label>Periodo</label>
      <select name="period">
        <option value="">Personalizado</option>
        <option value="daily" {% if selected.period == 'daily' %}selected{% endif %}>Diario</option>
        <option value="weekly" {% if selected.period == 'weekly' %}selected{% endif %}>Semanal</option>
        <option value="biweekly" {% if selected.period == 'biweekly' %}selected{% endif %}>Quincenal</option>
      </select>
    </div>
    <div>
      <label>Inicio</label>
      <input type="date" name="start" value="{{ selected.start }}" />
    </div>
    <div>
      <label>Fin</label>
      <input type="date" name="end" value="{{ selected.end }}" />
    </div>
    <div>
      <label>Usuario</label>
      <select name="user">
        <option value="">Todos</option>
        {% for u in users %}
        <option value="{{ u.id }}" {% if selected.user|add:'0' == u.id|add:'0' %}selected{% endif %}>{{ u.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Equipo</label>
      <select name="team">
        <option value="">Todos</option>
        {% for t in teams %}
        <option value="{{ t.id }}" {% if selected.team|add:'0' == t.id|add:'0' %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button type="submit" class="btn">Filtrar</button>
    </div>
  </form>

  <div style="margin:8px 0; display:flex; gap:8px;">
    <a class="btn" href="{% url 'reports:export_history_excel' %}?period={{ selected.period }}&start={{ selected.start }}&end={{ selected.end }}&user={{ selected.user }}&team={{ selected.team }}">Exportar Excel</a>
    <a class="btn" href="{% url 'reports:export_history_pdf' %}?period={{ selected.period }}&start={{ selected.start }}&end={{ selected.end }}&user={{ selected.user }}&team={{ selected.team }}">Exportar PDF</a>
    {% if user.is_admin %}
    <a class="btn warn" href="{% url 'reports:close_biweekly' %}">Cerrar Quincena</a>
    {% endif %}
  </div>

  <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 16px;">
    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Usuario</th>
            <th>Equipo</th>
            <th>Actividad</th>
            <th>Puntos</th>
            <th>Evidencia</th>
          </tr>
        </thead>
        <tbody>
          {% for a in activities %}
          <tr>
            <td>{{ a.date }}</td>
            <td>{{ a.user.name }}</td>
            <td>{% if a.user.team %}{{ a.user.team.name }}{% else %}-{% endif %}</td>
            <td>{{ a.activity_type.name }}</td>
            <td>{{ a.activity_type.points }}</td>
            <td>{{ a.evidence|default:'-' }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" style="text-align:center; color:var(--text-2)">No hay actividades con los filtros seleccionados.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <aside class="card">
      <h3>Estad√≠sticas</h3>
      <ul style="list-style:none; padding:0; margin:0;">
        <li style="display:flex; justify-content:space-between; margin:6px 0;">
          <span>Total actividades:</span>
          <strong>{{ stats.total_activities }}</strong>
        </li>
        <li style="display:flex; justify-content:space-between; margin:6px 0;">
          <span>Puntos totales:</span>
          <strong>{{ stats.total_points }}</strong>
        </li>
        <li style="display:flex; justify-content:space-between; margin:6px 0;">
          <span>Usuarios activos:</span>
          <strong>{{ stats.active_users }}</strong>
        </li>
        <li style="display:flex; justify-content:space-between; margin:6px 0;">
          <span>Promedio diario:</span>
          <strong>{{ stats.daily_average }}</strong>
        </li>
      </ul>
    </aside>
  </div>

  
</div>
{% endblock %}


